---
import content from "../data/content.json";
import { getImage } from "astro:assets";

const { navigation, businessInfo, services } = content;
const navItems = navigation.items;

const serviceLinks = services.list.map((service: any) => ({
  label: service.title,
  href: `/service/${service.slug}`,
}));

// Use absolute path for logo
const logoSrc = "/img/logo.png";
---

<nav
  id="main-nav"
  class="fixed top-0 z-50 w-full transition-all duration-300 bg-white/90 backdrop-blur-lg border-b border-border/40"
>
  <div
    class="flex justify-between items-center py-2 md:py-3 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto"
  >
    <!-- Logo -->
    <a href="/" class="flex items-center">
      <img
        src={logoSrc}
        alt="Lules Cleaning"
        class="h-12 sm:h-14 md:h-16 w-auto object-contain"
      />
    </a>

    <!-- Desktop Navigation -->
    <div class="hidden md:flex items-center gap-8">
      {
        navItems.map((item) => (
          <a
            href={item.href}
            class="nav-link relative text-base font-semibold text-gray-700 hover:text-purple-600 transition-all duration-300"
          >
            {item.label}
          </a>
        ))
      }

      <!-- Services Dropdown -->
      <div class="relative services-dropdown">
        <a
          href="/services"
          id="services-link"
          class="nav-link flex items-center gap-1 text-base font-semibold text-gray-700 hover:text-purple-600 transition-all duration-300"
        >
          Services
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="chevron-icon transition-transform"
          >
            <path d="m6 9 6 6 6-6"></path>
          </svg>
        </a>

        <div
          class="services-menu absolute top-full left-0 mt-2 w-56 bg-gray-50 backdrop-blur-md border border-gray-300 rounded-xl shadow-2xl opacity-0 invisible transition-all duration-200 z-50"
        >
          {
            serviceLinks.map((service) => (
              <a
                href={service.href}
                class="block px-4 py-3 text-sm text-gray-700 hover:text-purple-600 hover:bg-purple-50 transition-all duration-200 first:rounded-t-xl last:rounded-b-xl font-medium"
              >
                {service.label}
              </a>
            ))
          }
        </div>
      </div>
    </div>

    <!-- CTA Buttons -->
    <div class="hidden md:flex items-center gap-3">
      <a
        href={`tel:${businessInfo.phoneRaw}`}
        class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-primary hover:text-primary/80 transition-colors"
      >
        <!-- Phone Icon -->
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><path
            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
          ></path></svg
        >
        <span>Call Now</span>
      </a>
      <button
        class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2"
      >
        Get Quote
      </button>
    </div>

    <!-- Mobile Menu Button -->
    <button id="mobile-menu-btn" class="md:hidden p-2" aria-label="Toggle menu">
      <!-- Menu Icon -->
      <svg
        id="menu-icon"
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        ><line x1="4" x2="20" y1="12" y2="12"></line><line
          x1="4"
          x2="20"
          y1="6"
          y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg
      >
      <!-- X Icon (Hidden initially) -->
      <svg
        id="close-icon"
        class="hidden"
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        ><path d="M18 6 6 18"></path><path d="m6 6 18 18"></path></svg
      >
    </button>
  </div>

  <!-- Mobile Navigation -->
  <div
    id="mobile-menu"
    class="hidden md:hidden pb-6 space-y-1 animate-in fade-in slide-in-from-top-2 max-h-[calc(100vh-80px)] overflow-y-auto"
  >
    {
      navItems.map((item) => (
        <a
          href={item.href}
          class="mobile-nav-link block text-base font-medium text-foreground/80 hover:text-foreground hover:bg-accent/5 transition-all py-3 px-2 rounded-md"
        >
          {item.label}
        </a>
      ))
    }

    <!-- Mobile Services -->
    <div class="space-y-1 pt-2 mt-2 border-t border-border">
      <button
        id="mobile-services-toggle"
        class="w-full flex items-center justify-between text-base font-medium text-foreground py-3 px-2 rounded-md hover:bg-accent/5 transition-all"
      >
        <span>Services</span>
        <svg
          id="mobile-services-icon"
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="transition-transform duration-200"
        >
          <path d="m6 9 6 6 6-6"></path>
        </svg>
      </button>

      <div id="mobile-services-menu" class="hidden space-y-1 pl-4">
        {
          serviceLinks.map((service) => (
            <a
              href={service.href}
              class="mobile-nav-link block text-sm text-foreground/70 hover:text-primary hover:bg-accent/5 py-2.5 px-2 rounded-md transition-all"
            >
              {service.label}
            </a>
          ))
        }
        <a
          href="/services"
          class="mobile-nav-link flex items-center gap-1 text-sm font-semibold text-primary hover:bg-accent/5 py-2.5 px-2 rounded-md transition-all"
        >
          View All Services
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M5 12h14"></path>
            <path d="m12 5 7 7-7 7"></path>
          </svg>
        </a>
      </div>
    </div>

    <div class="pt-4 mt-3 space-y-3 border-t border-border">
      <a
        href={`tel:${businessInfo.phoneRaw}`}
        class="flex items-center gap-2 text-base font-medium text-primary hover:text-primary/80 py-2 px-2 hover:bg-accent/5 rounded-md transition-all"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
          ></path>
        </svg>
        {businessInfo.phone}
      </a>
      <button
        class="w-full inline-flex items-center justify-center whitespace-nowrap rounded-md text-base font-semibold ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-12 px-6 py-3 shadow-lg"
      >
        Get Quote
      </button>
    </div>
  </div>
</nav>

<script>
  // Lógica para el menú móvil
  const menuBtn = document.getElementById("mobile-menu-btn");
  const mobileMenu = document.getElementById("mobile-menu");
  const menuIcon = document.getElementById("menu-icon");
  const closeIcon = document.getElementById("close-icon");
  const mobileLinks = document.querySelectorAll(".mobile-nav-link");

  function toggleMenu() {
    const isHidden = mobileMenu?.classList.contains("hidden");

    if (isHidden) {
      mobileMenu?.classList.remove("hidden");
      menuIcon?.classList.add("hidden");
      closeIcon?.classList.remove("hidden");
    } else {
      mobileMenu?.classList.add("hidden");
      menuIcon?.classList.remove("hidden");
      closeIcon?.classList.add("hidden");
    }
  }

  menuBtn?.addEventListener("click", toggleMenu);

  // Cerrar menú al hacer clic en un enlace
  mobileLinks.forEach((link) => {
    link.addEventListener("click", () => {
      if (!mobileMenu?.classList.contains("hidden")) {
        toggleMenu();
      }
    });
  });

  // Toggle mobile services submenu
  const mobileServicesToggle = document.getElementById(
    "mobile-services-toggle"
  );
  const mobileServicesMenu = document.getElementById("mobile-services-menu");
  const mobileServicesIcon = document.getElementById("mobile-services-icon");

  mobileServicesToggle?.addEventListener("click", () => {
    const isHidden = mobileServicesMenu?.classList.contains("hidden");

    if (isHidden) {
      mobileServicesMenu?.classList.remove("hidden");
      mobileServicesIcon?.classList.add("rotate-180");
    } else {
      mobileServicesMenu?.classList.add("hidden");
      mobileServicesIcon?.classList.remove("rotate-180");
    }
  });

  // Dropdown de servicios en desktop
  const servicesDropdown = document.querySelector(".services-dropdown");
  const servicesMenu = document.querySelector(".services-menu");
  const chevronIcon = document.querySelector(".chevron-icon");
  const servicesLink = document.getElementById("services-link");
  let isMenuOpen = false;

  if (servicesDropdown && servicesMenu && servicesLink) {
    // Hover para desktop
    servicesDropdown.addEventListener("mouseenter", () => {
      servicesMenu.classList.remove("opacity-0", "invisible");
      servicesMenu.classList.add("opacity-100", "visible");
      chevronIcon?.classList.add("rotate-180");
      isMenuOpen = true;
    });

    servicesDropdown.addEventListener("mouseleave", () => {
      servicesMenu.classList.add("opacity-0", "invisible");
      servicesMenu.classList.remove("opacity-100", "visible");
      chevronIcon?.classList.remove("rotate-180");
      isMenuOpen = false;
    });

    // Click para tablets/táctiles
    servicesLink.addEventListener("click", (e) => {
      // Siempre prevenir si el menú no está abierto
      if (!isMenuOpen) {
        e.preventDefault();
        e.stopPropagation();

        // Abrir el dropdown
        servicesMenu.classList.remove("opacity-0", "invisible");
        servicesMenu.classList.add("opacity-100", "visible");
        chevronIcon?.classList.add("rotate-180");
        isMenuOpen = true;
      }
      // Si ya está abierto, dejarlo navegar normalmente (no hacemos nada)
    });

    // Cerrar al tocar fuera
    document.addEventListener("click", (e) => {
      if (!servicesDropdown.contains(e.target as Node) && isMenuOpen) {
        servicesMenu.classList.add("opacity-0", "invisible");
        servicesMenu.classList.remove("opacity-100", "visible");
        chevronIcon?.classList.remove("rotate-180");
        isMenuOpen = false;
      }
    });
  }
</script>

<style>
  .nav-link {
    position: relative;
  }

  .nav-link::after {
    content: "";
    position: absolute;
    width: 0;
    height: 2px;
    bottom: -4px;
    left: 50%;
    background: linear-gradient(90deg, #a855f7, #ec4899);
    transition: all 0.3s ease;
    transform: translateX(-50%);
  }

  .nav-link:hover::after {
    width: 100%;
  }
</style>
